# üìã T√≥m T·∫Øt Logic Nghi·ªáp V·ª• & C·∫•u Tr√∫c API

## üéØ T·ªïng Quan D·ª± √Ån

**Banking Deposit API** - H·ªá th·ªëng qu·∫£n l√Ω giao d·ªãch ti·ªÅn g·ª≠i ng√¢n h√†ng
- **Framework**: Spring Boot 3.2.0
- **Database**: PostgreSQL 16
- **Architecture**: Clean Architecture (4 layers)
- **Build**: Gradle 8.12

---

## üèóÔ∏è Ki·∫øn Tr√∫c Clean Architecture

### Layer 1: Domain (Domain Layer)
**V·ªã tr√≠**: `src/main/java/com/banking/deposit/domain/model/`

#### 1.1. Deposit Entity
```java
@Entity
public class Deposit {
    - id: Long (auto-generated)
    - accountNumber: String (s·ªë t√†i kho·∫£n)
    - amount: BigDecimal (s·ªë ti·ªÅn)
    - status: DepositStatus (tr·∫°ng th√°i)
    - currency: String (ƒë∆°n v·ªã ti·ªÅn t·ªá)
    - description: String (m√¥ t·∫£)
    - createdAt: LocalDateTime (th·ªùi gian t·∫°o)
    - updatedAt: LocalDateTime (th·ªùi gian c·∫≠p nh·∫≠t)
}
```

**T√≠nh nƒÉng t·ª± ƒë·ªông:**
- `@PrePersist`: T·ª± ƒë·ªông set createdAt, updatedAt khi t·∫°o m·ªõi
- `@PreUpdate`: T·ª± ƒë·ªông c·∫≠p nh·∫≠t updatedAt khi ch·ªânh s·ª≠a
- Sequence generator cho ID

#### 1.2. DepositStatus Enum
```java
public enum DepositStatus {
    PENDING,    // ƒêang ch·ªù x·ª≠ l√Ω
    COMPLETED,  // ƒê√£ ho√†n th√†nh
    FAILED,     // Th·∫•t b·∫°i
    CANCELLED   // ƒê√£ h·ªßy
}
```

---

### Layer 2: Application (Business Logic)
**V·ªã tr√≠**: `src/main/java/com/banking/deposit/application/`

#### 2.1. DTOs (Data Transfer Objects)

**DepositRequest** - D·ªØ li·ªáu nh·∫≠n v√†o
```java
- accountNumber: String (validation: 8-20 k√Ω t·ª±, ch·ªØ hoa + s·ªë)
- amount: BigDecimal (validation: > 0, t·ªëi ƒëa 2 ch·ªØ s·ªë th·∫≠p ph√¢n)
- currency: String (validation: 3 k√Ω t·ª± ISO code)
- description: String (t·ªëi ƒëa 500 k√Ω t·ª±)
```

**DepositResponse** - D·ªØ li·ªáu tr·∫£ v·ªÅ
```java
- id: Long
- accountNumber: String
- amount: BigDecimal
- status: DepositStatus
- currency: String
- description: String
- createdAt: LocalDateTime
- updatedAt: LocalDateTime
```

**ApiErrorResponse** - L·ªói tr·∫£ v·ªÅ
```java
- timestamp: LocalDateTime
- status: int (HTTP status code)
- error: String
- message: String
- path: String
- validationErrors: List<ValidationError>
```

#### 2.2. DepositService (Business Logic)

**C√°c nghi·ªáp v·ª•:**

1. **createDeposit()** - T·∫°o giao d·ªãch m·ªõi
   - Nh·∫≠n DepositRequest
   - Validate d·ªØ li·ªáu (Bean Validation)
   - Map DTO ‚Üí Entity (DepositMapper)
   - Set status = PENDING m·∫∑c ƒë·ªãnh
   - L∆∞u v√†o database
   - Tr·∫£ v·ªÅ DepositResponse

2. **getDepositById()** - L·∫•y theo ID
   - T√¨m trong database
   - N·∫øu kh√¥ng c√≥ ‚Üí throw ResourceNotFoundException
   - Tr·∫£ v·ªÅ DepositResponse

3. **getAllDeposits()** - L·∫•y t·∫•t c·∫£ (c√≥ ph√¢n trang)
   - H·ªó tr·ª£ Pageable (page, size, sort)
   - Tr·∫£ v·ªÅ Page<DepositResponse>

4. **getDepositsByAccountNumber()** - L·∫•y theo s·ªë t√†i kho·∫£n
   - T√¨m theo accountNumber
   - C√≥ ph√¢n trang
   - Tr·∫£ v·ªÅ Page<DepositResponse>

5. **updateDepositStatus()** - C·∫≠p nh·∫≠t tr·∫°ng th√°i
   - T√¨m deposit theo ID
   - Ki·ªÉm tra t·ªìn t·∫°i
   - Update status
   - L∆∞u v√†o database
   - Tr·∫£ v·ªÅ DepositResponse m·ªõi

6. **deleteDeposit()** - X√≥a giao d·ªãch
   - Ki·ªÉm tra t·ªìn t·∫°i
   - X√≥a kh·ªèi database

**ƒê·∫∑c ƒëi·ªÉm:**
- `@Transactional` cho t·∫•t c·∫£ methods
- `@Transactional(readOnly = true)` cho get methods
- Logging m·ªçi thao t√°c
- Exception handling

#### 2.3. DepositMapper
- Chuy·ªÉn ƒë·ªïi DepositRequest ‚Üí Deposit (Entity)
- Chuy·ªÉn ƒë·ªïi Deposit (Entity) ‚Üí DepositResponse
- S·ª≠ d·ª•ng MapStruct (compile-time)

#### 2.4. Exceptions
- **ResourceNotFoundException**: Khi kh√¥ng t√¨m th·∫•y resource
- **ValidationException**: Khi d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá

---

### Layer 3: Infrastructure (Persistence)
**V·ªã tr√≠**: `src/main/java/com/banking/deposit/infrastructure/repository/`

#### DepositRepository
```java
public interface DepositRepository extends JpaRepository<Deposit, Long> {
    
    // T√¨m theo accountNumber c√≥ ph√¢n trang
    Page<Deposit> findByAccountNumber(String accountNumber, Pageable pageable);
    
    // T√¨m theo status
    List<Deposit> findByStatus(DepositStatus status);
    
    // T√¨m theo ID v√† accountNumber
    Optional<Deposit> findByIdAndAccountNumber(Long id, String accountNumber);
    
    // Ki·ªÉm tra t·ªìn t·∫°i
    boolean existsByAccountNumber(String accountNumber);
    
    // ƒê·∫øm s·ªë l∆∞·ª£ng
    long countByAccountNumber(String accountNumber);
}
```

**Features:**
- Custom queries v·ªõi Spring Data JPA
- T·ª± ƒë·ªông implement b·ªüi Spring
- Type-safe

---

### Layer 4: Presentation (API Layer)
**V·ªã tr√≠**: `src/main/java/com/banking/deposit/presentation/`

#### DepositController
**Base URL**: `/api/v1/deposits`

**Endpoints:**

1. **POST** `/api/v1/deposits`
   - T·∫°o deposit m·ªõi
   - Input: DepositRequest (JSON)
   - Output: DepositResponse
   - Status: 201 Created

2. **GET** `/api/v1/deposits/{id}`
   - L·∫•y theo ID
   - Output: DepositResponse
   - Status: 200 OK
   - Error: 404 Not Found

3. **GET** `/api/v1/deposits`
   - L·∫•y t·∫•t c·∫£ (paginated)
   - Query params: page, size, sort
   - Output: Page<DepositResponse>
   - Status: 200 OK

4. **GET** `/api/v1/deposits/account/{accountNumber}`
   - L·∫•y theo account number
   - Query params: page, size
   - Output: Page<DepositResponse>
   - Status: 200 OK

5. **PATCH** `/api/v1/deposits/{id}/status?status={status}`
   - C·∫≠p nh·∫≠t status
   - Query param: status (enum)
   - Output: DepositResponse
   - Status: 200 OK

6. **DELETE** `/api/v1/deposits/{id}`
   - X√≥a deposit
   - Status: 204 No Content
   - Error: 404 Not Found

**ƒê·∫∑c ƒëi·ªÉm:**
- `@Valid` cho validation
- Pagination m·∫∑c ƒë·ªãnh: 20 items/page
- Sort m·∫∑c ƒë·ªãnh: createdAt DESC
- RESTful conventions

#### GlobalExceptionHandler
**X·ª≠ l√Ω l·ªói to√†n c·ª•c:**

1. **ResourceNotFoundException** ‚Üí 404 Not Found
2. **ValidationException** ‚Üí 400 Bad Request
3. **MethodArgumentNotValidException** ‚Üí 400 Bad Request (v·ªõi chi ti·∫øt validation)
4. **IllegalArgumentException** ‚Üí 400 Bad Request
5. **Exception** (general) ‚Üí 500 Internal Server Error

**Response format:**
```json
{
  "timestamp": "2024-01-15T10:30:00",
  "status": 404,
  "error": "Not Found",
  "message": "Deposit not found with id: 123",
  "path": "/api/v1/deposits/123"
}
```

---

## üíæ Database Schema

### Deposits Table
```sql
CREATE TABLE deposits (
    id BIGSERIAL PRIMARY KEY,
    account_number VARCHAR(50) NOT NULL,
    amount DECIMAL(19,2) NOT NULL,
    status VARCHAR(20) NOT NULL,
    currency VARCHAR(3) NOT NULL,
    description VARCHAR(500),
    created_at TIMESTAMP NOT NULL,
    updated_at TIMESTAMP NOT NULL
);

-- Indexes
CREATE INDEX idx_deposits_account_number ON deposits(account_number);
CREATE INDEX idx_deposits_status ON deposits(status);
CREATE INDEX idx_deposits_created_at ON deposits(created_at);
```

**Migration:**
- S·ª≠ d·ª•ng Liquibase
- File: `src/main/resources/db/changelog/changelog/001-create-deposits-table.yaml`
- T·ª± ƒë·ªông ch·∫°y khi application start

---

## üîÑ Flow Logic Nghi·ªáp V·ª•

### Flow 1: T·∫°o Deposit M·ªõi
```
Client Request (POST /api/v1/deposits)
    ‚Üì
Controller @Valid DepositRequest
    ‚Üì
Validation (Bean Validation)
    ‚îú‚îÄ‚îÄ accountNumber: 8-20 chars, uppercase+numbers
    ‚îú‚îÄ‚îÄ amount: > 0, max 2 decimals
    ‚îú‚îÄ‚îÄ currency: 3 chars ISO code
    ‚îî‚îÄ‚îÄ description: max 500 chars
    ‚Üì
Service.createDeposit()
    ‚Üì
Mapper: DepositRequest ‚Üí Deposit Entity
    ‚Üì
Set status = PENDING
Set createdAt, updatedAt = now()
    ‚Üì
Repository.save()
    ‚Üì
Response: DepositResponse
    ‚Üì
HTTP 201 Created
```

### Flow 2: C·∫≠p Nh·∫≠t Status
```
Client Request (PATCH /api/v1/deposits/1/status?status=COMPLETED)
    ‚Üì
Controller
    ‚Üì
Service.updateDepositStatus(id, status)
    ‚Üì
Repository.findById(id)
    ‚îú‚îÄ‚îÄ Found ‚Üí Get entity
    ‚îî‚îÄ‚îÄ Not Found ‚Üí throw ResourceNotFoundException
    ‚Üì
Entity.setStatus(status)
Entity.setUpdatedAt(now())
    ‚Üì
Repository.save()
    ‚Üì
Response: DepositResponse
    ‚Üì
HTTP 200 OK
```

### Flow 3: X·ª≠ L√Ω L·ªói
```
Exception occurred
    ‚Üì
GlobalExceptionHandler catches
    ‚Üì
Determine exception type
    ‚îú‚îÄ‚îÄ ResourceNotFoundException ‚Üí 404
    ‚îú‚îÄ‚îÄ ValidationException ‚Üí 400
    ‚îú‚îÄ‚îÄ MethodArgumentNotValidException ‚Üí 400 (with details)
    ‚îî‚îÄ‚îÄ Others ‚Üí 500
    ‚Üì
Build ApiErrorResponse
    ‚Üì
Return JSON with error details
```

---

## ‚úÖ Validation Rules

### Account Number
- Required: Yes
- Length: 8-20 characters
- Pattern: Only uppercase letters (A-Z) and numbers (0-9)
- Regex: `^[A-Z0-9]+$`

### Amount
- Required: Yes
- Minimum: 0.01
- Precision: 19 digits, 2 decimal places
- Format: `12345678901234567.89`

### Currency
- Required: Yes
- Format: ISO 4217 code
- Length: Exactly 3 characters
- Examples: USD, EUR, GBP, VND
- Pattern: `^[A-Z]{3}$`

### Description
- Required: No
- Max Length: 500 characters

---

## üß™ Testing Strategy

### Unit Tests
- `DepositServiceTest`: Test business logic
  - Create deposit
  - Get by ID
  - Update status
  - Delete
  - Error cases
  
- `DepositControllerTest`: Test API layer
  - HTTP status codes
  - Request/response format
  - Validation

### Integration Tests
- Database connection
- Liquibase migrations
- End-to-end API calls

---

## üìä API Summary Table

| Method | Endpoint | Function | Input | Output | Status |
|--------|----------|----------|-------|--------|--------|
| POST | `/api/v1/deposits` | Create | DepositRequest | DepositResponse | 201 |
| GET | `/api/v1/deposits/{id}` | Get by ID | - | DepositResponse | 200 |
| GET | `/api/v1/deposits` | Get all | Pageable | Page<DepositResponse> | 200 |
| GET | `/api/v1/deposits/account/{account}` | Get by account | - | Page<DepositResponse> | 200 |
| PATCH | `/api/v1/deposits/{id}/status` | Update status | status param | DepositResponse | 200 |
| DELETE | `/api/v1/deposits/{id}` | Delete | - | - | 204 |

---

## üîê Security & Best Practices

1. **Validation**: D√πng Bean Validation ·ªü c·∫£ client v√† server
2. **Transactions**: T·∫•t c·∫£ database operations ƒë·ªÅu transactional
3. **Logging**: Log m·ªçi thao t√°c ƒë·ªÉ audit
4. **Error Handling**: Global exception handler cho consistent errors
5. **ID Generation**: Sequence generator cho database performance
6. **Timestamps**: T·ª± ƒë·ªông qu·∫£n l√Ω created/updated timestamps
7. **Clean Code**: Separation of concerns r√µ r√†ng

---

## üéØ Key Points

‚úÖ **Clean Architecture**: R√µ r√†ng 4 layers
‚úÖ **RESTful**: Tu√¢n th·ªß REST conventions  
‚úÖ **Validation**: Multi-level validation
‚úÖ **Error Handling**: Comprehensive error management
‚úÖ **Pagination**: Efficient data retrieval
‚úÖ **Logging**: Full audit trail
‚úÖ **Testing**: Unit + Integration tests
‚úÖ **Migration**: Database versioning v·ªõi Liquibase

**ƒê√¢y l√† m·ªôt production-ready banking API!**

